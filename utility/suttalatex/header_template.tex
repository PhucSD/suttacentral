{% raw %}
\RequirePackage{fix-cm}%fixes a few bugs in LaTeX2e, see documentation for details, note that documentation says it should be invoked like this.
\documentclass[11pt,openany]{book}
%\usepackage{showframe}
{% endraw %}
\usepackage{{ '[' }}{{ transl_dict['transl_language'] }}{{ ']' }}{babel}
{% raw %}
%PACKAGES%
\usepackage[inner=1.2in, width=4in, top=1in, height=6.667in, papersize={6in, 9in},footnotesep=1.2\baselineskip,marginparwidth=2em, marginparsep=1em]{geometry}%this defines page size and overall layout. 
%\usepackage{graphicx}%include photos and other graphics, probably not needed.
\usepackage{fontspec}%define fonts
\usepackage{enumitem}%greater control over lists,
\usepackage{sectsty}%style sections
\usepackage[explicit,raggedright]{titlesec}%also for styling sections. Explicit does something I don't know what, but something. Raggedright suppresses hyphenation in section titles
\usepackage{verse}% for laying out verses
%\usepackage{multirow}%tables: we probably won't need this, but maybe for intros and the like. Tables are complex in LaTeX, if they are needed they require special attention. I used them extensivley in A History of Mindfulness.
%\usepackage{array}%tables
\usepackage[hyphens]{url}%allows hyphenating URLs.
\usepackage[tocflat]{tocstyle}% for styling ToC
\usepackage{tocloft}%styling ToC
\usepackage{soulutf8}%expanding text (letterspacing), mainly used for smallcaps, for which case it supplies the macro \caps. Use this rather than \textsc for all uses of small caps that are not tight on space. However it doesn't play well with the headers, so not used there.
\usepackage{hanging}%allows hanging punctuation
%\usepackage[cam,a4,center]{crop} This is for adding crop marks, which are required by some printers.

%this snippet of code is a bit of a hack to allow line break after em-dash (http://tex.stackexchange.com/questions/62800/lualatex-and-line-breaks-after-em-dashes)
\catcode`\—=13
\protected\def—{\unskip\textemdash\allowbreak}

%\usepackage{pagegrid} Use this for testing purposes if you want to see how the text fits on a grid.
%PACKAGES%
%\pagegridsetup{top-left, step=3.435in}

%ADD BLANK PAGES AT END OF BOOK% Use this if the printer requires that we add the pages up to a multiple of four, normally this should be done automatically however.
%\newcommand{\blankpage}{\\
%\newpage\\
%\thispagestyle{empty}
%\mbox{}
%\newpage\\
%}
%ADD BLANK PAGES AT END OF BOOK%

%TABLE OF CONTENTS%style ToC using tocstyle
\settocstylefeature[]{leaders}{\hfill}%ELIMINATES DOTS between chapter title and page number; these were described by Goudy as leading the eye ``like a prisoner to their cell''.
\settocstylefeature[]{entryhook}{\SkolarTabular}%makes numbers tabular. I have set up numbers generally to use the correct forms:
%lining numbers are like CAPS: they work best where the text defines its own space, I have used them for page numbers and headings
%Tabular numbers are so that numerals are vertically aligned, as in tables, etc
%"Oldstyle numbers" are where the numerals extend below the line, similar to ordinary lowercase text, and is best used when set with running text.
%Smallcaps numbers are used with small caps
%Script numbers are used for tiny numbers, like footnote anchors. They are readable at small sizes, and do not become ``faint'' compared to the normal text.

\settocstylefeature[]{raggedhook}{\raggedright}%This ensures that the chapter heading does not bump up against the page number, and that there is no hyphenation
\settocstylefeature[]{entryvskip}{0.2em}%Adjust vertical space between entries. This should be adjusted by hand. Not necessary, but allows it to breathe a little more. 
\settocstylefeature[0]{entryvskip}{1em}%VERTICAL SPACE BEFORE CHAPTER ENTRIES% Inserts a little extra space before the chapter entries
\settocstylefeature[0]{entryhook}{\bfseries}%FONT FOR CHAPTER ENTRIES% Makes chapter entries use bold
\settocstylefeature[0]{pagenumberbox}{\csname @gobble\endcsname}%remove page numbers for chapters
\renewcommand*{\cfttoctitlefont}{\Secfont\Large}%use tocloft to define style for ToC title
%TABLE OF CONTENTS%

%Linespace: LaTeX typically allows just enough linespace, about 120%. This adds a little more.
\usepackage{setspace}
\setstretch{1.15}
%LINESPAce%

%LaTeX default adds a line between list items, this compatcifies them.
\setlist[itemize]{noitemsep}
\setlist[enumerate]{noitemsep}

%FONTS% These are the normal SC fonts. We have a ``light'' skolar, too. Semibold is used for headings, as Skolar's bold is too bold. But some systems don't pick up the italic automatically, so we have to specify it.
\setmainfont[Numbers=OldStyle]{Skolar PE}
\setsansfont[Scale = MatchLowercase]{Skolar Sans Latin}% This can be downloaded for free from Rosetta
\setmonofont{Source Code Pro}%Another free font, but will rarely if ever be used
\newfontfamily\SkolarSC[RawFeature=+c2sc]{Skolar PE}
\newfontfamily\SkolarLightSC[RawFeature=+c2sc]{Skolar PE Light}%this use of ``raw feature'' enables direct access to OpenType features, in this case allowing the use of small caps numerals in a small caps context, as is used in Chapter headings and page header. Compare CSS font-feature-settings ``all-small-caps''
\newfontfamily\SkolarLight{Skolar PE Light}%used for chapter titles
\newfontfamily\SkolarLining[Numbers=Lining]{Skolar PE}
\newfontfamily\SkolarTabular[Numbers=Monospaced]{Skolar PE}


\titleformat{\chapter}[display]
{\filcenter}
{}
{1ex}
{\SkolarLight\Huge {#1}
\addcontentsline{toc}{chapter}{#1}
\markboth{#1}{#1}}

\newfontfamily\Secfont[Numbers=Lining,ItalicFont=Skolar Sb PE Italic]{Skolar Sb PE}%Used for sections. In this case I had to explicitly define the italic font because otherwise LaTeX didn't detect it and produced only upright.


\titleformat{\section}
  {\centering\Secfont\Large\mdseries}{\thesection}{1em}{\caps{#1}}


  \titleformat{\subsection}
  {\Secfont\mdseries\large\raggedright}{}{}{#1}

  \titleformat{\subsubsection}
  {\Secfont\mdseries\raggedright}{}{}{#1}

%This is a suggestion for how to handle heading tags of level <h4> and down. They won't be included in ToC or anything, just given a little styling. We hardly ever go beyond h3, but do go to h6 in a couple of places, namely the Patthana and Vinaya, so worthwhile anticipating this. We could call them \subsubsubsubsection and so on but it gets a little headachy.

\newcommand\hfour
{\medskip\noindent\textit}

\newcommand\hfive
{\medskip\noindent\textit}

\newcommand\hsix
{\medskip\noindent\textit}

%Defines font with lining numerals for lists
\newfontfamily\enumfont[Numbers=Lining]{Skolar PE}
\setlist[itemize,enumerate]{noitemsep,listparindent=\parindent,font=\enumfont}

%HEADER and FOOTER% 
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{} % clear all header and footer fields
\fancyfoot[LE,RO]{\SkolarLining\thepage}
\renewcommand{\headrulewidth}{0pt}
\fancyhead[CO]{\headcaps{\MakeUppercase{\rightmark}}}
\renewcommand{\sectionmark}[1]{%
   \markright{#1}%
   \def\firstpara{0}\def\midpara{0}\def\lastpara{0}
}
\fancyhead[CE]{\headcaps{\MakeUppercase{\leftmark}}}
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
{% endraw %}
\fancyfoot[LO,RE]{\ifnum\firstpara>0\relax\footnotesize\headcapsfont {{ titleabr }} \thesection.\theparagraph\fi}
{% raw %}
\newfontfamily\headcapsfont[RawFeature=+c2sc]{Skolar PE}%THIS DEFINES THE SMALL CAPS FONT WITH SMALLCAPS NUMBER. IT TURNS CAPS INTO SMALL CAPS WHILE LEAVING LOWERCASE ALONE
\newcommand\headcaps[1]{{\headcapsfont #1}}
%\newcommand{\sectionbreak}{\newpage\thispagestyle{plain}}
\let\realSection\section
\renewcommand\section[2][\relax]{\clearpage%
  \thispagestyle{plain}%
  \ifx#1\relax\relax\realSection{#2}%
  \else\realSection[#1]{#2}%
  \fi
}
\renewcommand\thesection{\arabic{section}}

\def\firstpara{0}%
\def\midpara{0}%
\def\lastpara{0}%
\def\setparagraph#1-#2-#3|{\def\midpara{#1}%
   % if \firstpara=0 => new page => set \firstpara
   \ifnum\firstpara=0\relax\def\firstpara{#1}\fi%
   % if #2=0 => only #1 is meaningful to set \lastpara to this
   % otherwise use #2
   \ifnum#2=0\relax\def\lastpara{#1}%
   \else\def\lastpara{#2}%
   \fi%
}
\def\paragraph#1{%
  \setparagraph#1-0-|%
}
\def\theparagraph{
  % if \firstpara=\lastpara print only \firstpara otherwise print a range
  \ifnum\firstpara=\lastpara\relax\firstpara\else\firstpara-\lastpara\fi
  % reset firstpara and lastpara
  \xdef\firstpara{\midpara}%
  %\let\lastpara\relax%
}
% need to reset \firstpara on pages without headers
\fancypagestyle{plain}{ 
  \fancyhf{} 
  \fancyfoot[LE,RO]{\SkolarLining\thepage}
{% endraw %}
  \fancyfoot[LO,RE]{\ifnum\firstpara>0\relax\footnotesize\headcapsfont {{ titleabr }} \thesection.\theparagraph\fi}
{% raw %}
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}
%HEADER & FOOTER%

%HANGING LEFT%This allows handing punctuation, which is equivalent to what is added by the quotehanger on SC. Especially useful for verse. But the Latex code needs to be applied in the text, it is not automatic: \vleftofline{“}
\newcommand*{\vleftofline}[1]{\leavevmode\llap{#1}}
%HANGINGLEFT%

%VERSE%
\settowidth{\versewidth}
{mmmmmmmmmmmmmmmmmmmmmmmm}%THIS SETS THE GLOBAL DEFAULT WIDTH OF CENTERING. IT CAN ALSO BE DETERMINED LOCALLY.%
%VERSE%

%WIDOWS & ORPHANS% Check how this goes, it can be adjusted to reduce overfull boxes.
\widowpenalty=1000
\clubpenalty=1000
%WIDOWS & ORPHANS%

%Applies various subtle improvements in typography. Use default.
\usepackage{microtype}
\frenchspacing
%Compact lists

%enable use of real script numerals for footnotes and margin numbers
\usepackage{realscripts}

%This is a special envirnoment for the Sutta Nipata, but in fact it corresponds with the SuttaCentral class .speaker.
\newenvironment{speaker}
{\footnotesize \scshape\lowercase}%

%This correponds with the SC class ``subheading'', which is a special descriptive heading that sometimes appears under the main <h1> of a sutta, especially in en-dn and a few other places. For Snp it was used to supply the Pali title, which normally will not be necessary.
\newenvironment{undertitle} 
{\normalsize \caps}%

%FOOTNOTES% This adds a little more space to LaTeX's default footnote rule. It also sets the footnotes more nicely than the LaTeX default.
\usepackage[hang,splitrule]{footmisc}
\addtolength{\footskip}{0.5cm}
\setlength{\footnotemargin}{0.3cm}
\let\oldfootnoterule\footnoterule
\def\footnoterule{\oldfootnoterule\vspace{0.1\baselineskip}}
%FOOTNOTES%


\date{}

%This package allows bunches of different things. first, we insert author and title, which correctly keeps that in the pdf metadata. Keywords are up to you, they can probably be kept standard. We can use this also for coloring links, which we don't want in a printed edition, but is good for on-screen pdf. Finally we define Unicode, which allows Unicode characters in the Index for the pdf file.
{% endraw %}
\usepackage{{ '[' }}unicode, hidelinks, pdfauthor={{ '{' }}{{ transl_dict['author'] }}{{ '}' }}, pdftitle={{ '{' }}{{ transl_dict['title'] }}{{ '}' }}, pdfsubject={Buddhism}, pdfkeywords={Buddhism, bhik\-khu, monks, Sutta, tipitaka, tripitaka, sutra}, pdfproducer={LuaTeX beta-0.70.1}, pdfcreator={LaTeX2e}{{ ']' }}{hyperref}

\setcounter{section}{{ '{' }}{{ sectioncounter }}{{ '}' }}

%DOCUMENT INFO.%
\title{{ '{' }}{{ transl_dict['title_transl'] }}{{ '}' }}
\author{{ '{' }}{{ transl_dict['gotama_transl'] }}{{ '}' }}

\begin{document}

\frontmatter
\pagestyle{empty}

\maketitle

\newpage

\begin{small}

\noindent {{ transl_dict['publishedfor_transl'] }} SuttaCentral.

\medskip

\noindent {{ transl_dict['edition_notice'] }}\\

\noindent {{ transl_dict['copyright_notice'] }}

\medskip

\noindent {{ transl_dict['meta_area'] }}

\bigskip

\begin{center}{\sffamily suttacentral.net}\end{center}

\noindent ISBN Paperback: {{ transl_dict['isbn_paperback'] }}

\noindent ISBN Hardcover: {{ transl_dict['isbn_hardcover'] }}

\end{small}

\newpage


\begin{center}


\MakeLowercase{\caps{\sffamily {{ transl_dict['wordsofthebuddha_transl'] }}{{ '}' }}}

\vspace{1em}

\begin{spacing}{2.2}
{\Huge\Secfont {{ transl_dict['title_transl'] }}{{ '}' }}
\end{spacing}

\vspace{1em}

{\large\sffamily {{ transl_dict['volumenr_transl'] }}{{ '}' }}


\vfill

\emph{\large\sffamily {{ transl_dict['atranslationof_transl'] }}{{ '}' }}

\vspace{1em}

\caps{\LARGE {{ transl_dict['title'] }}{{ '}' }}

\vspace{1em}

\emph{\large\sffamily {{ transl_dict['by_transl'] }}{{ '}' }}

\vspace{1em}

\MakeLowercase{\caps{\Huge\SkolarLight {{ transl_dict['author'] }}{{ '}' }}}

\vfill

\emph{\sffamily {{ transl_dict['publishedby_transl'] }}{{ '}' }}

\smallskip

\caps{\Large SuttaCentral}

\end{center}

\newpage
\pagestyle{fancy}% replace this with pagestyle plain if you don't want Contents printed on every page and then move the pagestyle fancy to above the preface chapter heading.
\tableofcontents

\newpage

\chapter*{{ '{' }}{{ transl_dict['preface_transl'] }}{{ '}' }}

{% include prefacefile %}

\bigskip

\noindent {{ transl_dict['author'] }}

\noindent 

\mainmatter